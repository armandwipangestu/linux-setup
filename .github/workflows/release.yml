name: Release

on:
    push:
        branches:
            - main
            - staging

env:
    IMAGE_NAME: ghcr.io/armandwipangestu/linux-setup

jobs:
    release-and-tagging-version:
        name: Release and Tagging Version
        runs-on: ubuntu-latest
        permissions:
            contents: write
            issues: write
            pull-requests: write
        environment: ${{ github.ref_name }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js for Semantic Release
              uses: actions/setup-node@v4
              with:
                  node-version: "22"

            - name: Install semantic-release globally
              run: |
                  npm install -g \
                    semantic-release \
                    @semantic-release/changelog \
                    @semantic-release/git \
                    @semantic-release/exec \
                    @semantic-release/github \
                    conventional-changelog-conventionalcommits

            - name: Run semantic-release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: npx semantic-release

            - name: Upload version.txt artifact
              uses: actions/upload-artifact@v4
              with:
                  name: release-version
                  path: version.txt

    build-and-push-docker:
        name: Build and Push Docker Image
        runs-on: ubuntu-latest
        needs: release-and-tagging-version
        permissions:
            contents: write
            issues: write
            pull-requests: write
        environment: ${{ github.ref_name }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download version.txt artifact
              uses: actions/download-artifact@v4
              with:
                  name: release-version

            - name: Set VERSION env
              run: echo "VERSION=$(cat version.txt)" >> $GITHUB_ENV

            - name: Log in to GitHub Container Registry
              run: echo "${{ secrets.GH_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GH_USERNAME }}" --password-stdin

            - name: Determine build context
              id: vars
              run: |
                  echo "dockerfile=Dockerfile" >> $GITHUB_OUTPUT
                  if [[ "${GITHUB_REF##*/}" == "main" ]]; then
                    echo "tag=${VERSION}" >> $GITHUB_OUTPUT
                    echo "latest_tag=latest" >> $GITHUB_OUTPUT
                    echo "app_env=production" >> $GITHUB_OUTPUT
                  elif [[ "${GITHUB_REF##*/}" == "staging" ]]; then
                    echo "tag=${VERSION}" >> $GITHUB_OUTPUT
                    echo "app_env=development" >> $GITHUB_OUTPUT
                  fi

            - name: Build Docker Image
              run: |
                  docker build \
                    -f ${{ steps.vars.outputs.dockerfile }} \
                    --build-arg APP_VERSION=v${{ steps.vars.outputs.tag }} \
                    -t ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag }} .

            - name: Push Docker Image
              run: docker push ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag }}

            - name: Push latest tag if main
              if: github.ref_name == 'main'
              run: |
                  docker tag ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag }} ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.latest_tag }}
                  docker push ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.latest_tag }}
